{# @var craft \craft\web\twig\variables\CraftVariable #}
{# @var entry \craft\elements\Entry #}
{# ======================================================
  @filename: search
  ====================================================== #}
{#
  Search page
#}

{% extends "_layouts/_layout.twig" %}

{% block _inline_css %}
  <style>
    {{ source ("index_critical.min.css", ignore_missing = true) }}
  </style>
{% endblock %}

{% block content %}

  {% set searchQuery = craft.app.request.getParam('q') %}
  {% set pageLimit = 6 %}

  {% set items = craft.entries({
    search: searchQuery,
  }) %}

  {% paginate items.orderBy('score desc').limit(pageLimit) as pageInfo, entries %}

  <div class="container mt-4 mt-lg-6">
    <div class="row">
      <div class="col-lg-10 offset-lg-1">
        <h1 class="mb-4">Zoeken</h1>
        <form class="c-form-global-search mb-2" action="{{ url('zoeken') }}">
          <label for="q">
            {% include '_inline/_svg/search-regular.twig' %}
          </label>
          <input name="q" id="q" type="search"
                 placeholder="Zoeken naar..." {{ searchQuery | length ? 'value=' ~ searchQuery : '' }}>
        </form>

        {% if entries | length %}
          <p class="text-sm">
            {{ items | length }} resultaten gevonden voor <span class="weight-700">"{{ searchQuery }}"</span>
          </p>

          <ul class="mt-4 mt-lg-6">
            {% for entry in entries %}

              {# What assets fields should be checked? #}
              {% set assetFields = [
                'newsImage', 'hero', 'body'
              ] %}

              {% set image = '' %}

              {% for assetField in assetFields %}
                {% if entry[assetField] is defined and entry[assetField] | length %}
                  {% if entry[assetField].elementType != 'craft\\elements\\MatrixBlock' %}
                    {% set image = not image | length and entry[assetField] is defined and entry[assetField] | length ? entry[assetField][0] : '' %}
                  {% else %}
                    {% for item in entry[assetField].all() %}
                      {% if item.type == 'image' %}
                        {% set image = not image | length and item['image'] is defined and item['image'] | length ? item['image'][0] : '' %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              {# What summary fields should be checked? #}
              {% set summaryFields = [
                'summary', 'body', 'newsText'
              ] %}

              {% set summary = '' %}
              {% set maxSummaryChars = 100 %}

              {% for summaryField in summaryFields %}
                {% if not summary | length and entry[summaryField] is defined and entry[summaryField] | length %}
                  {% if not entry[summaryField]['elementType'] is defined %}
                    {% set summary = not summary | length and entry[summaryField] is defined and entry[summaryField] | length ? entry[summaryField] : '' %}
                  {% else %}
                    {% if entry[summaryField]['elementType'] is defined and entry[summaryField].elementType == 'craft\\elements\\MatrixBlock' %}
                      {% for item in entry[summaryField].all() %}
                        {% if item.type == 'text' %}
                          {% set summary = not summary | length and item['text'] is defined and item['text'] | length ? item['text'] : '' %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  {% endif %}
                {% endif %}
              {% endfor %}

              {% include '_partials/_components/card/card.twig' with {
                title: entry.title,
                url: entry.url,
                summary: summary | length > maxSummaryChars ? (summary | striptags | slice(0, maxSummaryChars) ~ '...')  | raw : summary,
                image: image,
                class: 'c-card__border'
              } %}
            {% endfor %}
          </ul>

          {% if items | length > pageLimit %}
            <nav class="mt-4 mb-6" aria-label="nieuws">
              <ul class="c-pagination pagination">
                <li class="c-pagination__item{{ pageInfo.prevUrl ? '' : ' disabled' }}">
                  <a class="c-pagination__link" href="{{ pageInfo.prevUrl }}">
                    {% include '_inline/_svg/angle-left-light.twig' %}
                  </a>
                </li>

                {% for page, url in pageInfo.getPrevUrls(3) %}
                  <li class="c-pagination__item">
                    <a class="c-pagination__link" href="{{ url }}">
                      {{ page }}
                      <span class="sr-only">(current)</span>
                    </a>
                  </li>
                {% endfor %}

                <li class="c-pagination__item c-pagination__item-active" aria-current="page">
                  <span class="c-pagination__link">{{ pageInfo.currentPage }}</span>
                </li>

                {% for page, url in pageInfo.getNextUrls(3) %}
                  <li class="c-pagination__item">
                    <a class="c-pagination__link" href="{{ url }}">{{ page }}</a>
                  </li>
                {% endfor %}

                <li class="c-pagination__item{{ pageInfo.nextUrl ? '' : ' disabled' }}">
                  <a class="c-pagination__link" href="{{ pageInfo.nextUrl }}">
                    {% include '_inline/_svg/angle-right-light.twig' %}
                  </a>
                </li>
              </ul>
            </nav>
          {% endif %}
        {% else %}
          <div class="bg-gray-300 p-2 mb-3">
            <p class="text-sm mb-0">De zoekterm <span class="weight-700">"{{ searchQuery }}"</span> heeft geen
              resultaten opgeleverd.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}

{% block _inline_js %}
{% endblock %}

